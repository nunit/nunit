trigger:
  branches:
    include: [ '*' ]
    exclude: [ 'refs/tags/*' ]

jobs:

- job: Windows
  pool:
    vmImage: vs2017-win2016
  steps:

  - powershell: .\build.ps1 --target=Test --test-run-name=Windows
    displayName: Build, test, and publish results

  - powershell: .\build.ps1 --target=Package --artifact-dir='$(Build.ArtifactStagingDirectory)'
    displayName: Package

  - task: PublishBuildArtifacts@1
    displayName: Save package artifacts
    inputs:
      PathtoPublish: $(Build.ArtifactStagingDirectory)
      ArtifactName: Package

- job: Linux
  pool:
    vmImage: ubuntu-16.04
  steps:
  - task: UseDotNet@2
    displayName: Stick with .NET Core SDK version compatible to Mono toolchain
    inputs:
      packageType: sdk
      version: 2.2.301  # See also: https://github.com/mono/mono/issues/13537
      installationPath: $(Agent.ToolsDirectory)/dotnet
  - bash: |
     dotnet tool install --global Cake.Tool
     export DOTNET_ROOT="$(Agent.ToolsDirectory)/dotnet"
     ~/.dotnet/tools/dotnet-cake --target=Test --test-run-name=Linux --configuration=Release
    displayName: Build, test, and publish results

- job: macOS
  pool:
    vmImage: macOS-10.13
  steps:
  - bash: |
     dotnet tool install --global Cake.Tool
     export DOTNET_ROOT="$(dirname "$(readlink "$(command -v dotnet)")")"
     ~/.dotnet/tools/dotnet-cake --target=Test --test-run-name=macOS --configuration=Release
    displayName: Build, test, and publish results
